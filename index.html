<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Emoticommits : Commits and comments with emotions are good for your health :smile:" />

    <script type="text/javascript">
      var page_time;

      var avatar_duration = 600*1000; // 10 min
      var avatar_size = 32;
      var emoticon_duration = 1800*1000;  // 30 min
      var emoticon_size = 48;

      function markersBasename(time) {
        var basename = time.getUTCFullYear();
        var m = time.getUTCMonth() + 1;
        if (m < 10) {
          basename += "0";
        }
        basename += m;
        basename += time.getUTCDate();
        var h = time.getUTCHours();
        if (h < 10) {
          basename += "0";
        }
        basename += h;
        return basename
      }

      var markers_queue = new Array;
      var loaded_markers_basename;
      function loadMarkers(basename) {
        if (basename != loaded_markers_basename) {
          var http = new XMLHttpRequest();
          http.open('GET', "markers/" + basename + ".json");
          http.send(null);
          loaded_markers_basename = basename;
          http.onreadystatechange = function() {
            if ((http.readyState == 4) && (http.status == 200)) {
              JSON.parse(http.responseText).forEach(function(marker) {
                if (page_time < new Date(marker.time)) {
                  markers_queue.push(marker);
                }
              });
            };
          };
        };
      };

      var avatars_on_map = new Array;
      var emoticons_on_map = new Array;
      function addMarkers(page_time, wall_time) {
        while(markers_queue.length > 0 && new Date(markers_queue[0].time) < page_time) {
          var marker = markers_queue.shift();
          var icon = marker.icon;
          var size;
          var until;
          if (marker.emotion) {
            size = emoticon_size;
            until = new Date(wall_time.getTime() + emoticon_duration);
          } else {
            size = avatar_size;
            icon += "?s=" + size;
            until = new Date(wall_time.getTime() + avatar_duration);
          };
          var pin = mapwindow.dropPin(marker.lat, marker.lng, icon, size, marker.url);
          if (marker.emotion) {
            emoticons_on_map.push({until: until, marker: pin});
          } else {
            avatars_on_map.push({until: until, marker: pin});
          }
        };
      };
      function removeMarkers(wall_time) {
        while(avatars_on_map.length > 0 && avatars_on_map[0].until < wall_time) {
          mapwindow.removePin(avatars_on_map.shift().marker);
        }
        while(emoticons_on_map.length > 0 && emoticons_on_map[0].until < wall_time) {
          mapwindow.removePin(emoticons_on_map.shift().marker);
        }
      }

      var time_offset = -24*3600*1000; // 1 day, for now
      var fetch_offset = 10*60*1000  // 10 minutes
      function updateClocks() {
        var wall_time = new Date();
        page_time = new Date(wall_time.getTime() + time_offset);
        document.getElementById("wall_clock").innerHTML = wall_time.toLocaleString();
        document.getElementById("page_clock").innerHTML = page_time.toLocaleString();
        addMarkers(page_time, wall_time);
        removeMarkers(wall_time);
      };

      var mapwindow;
      function initialize() {
        mapwindow = document.getElementById("mapframe").contentWindow;
        setInterval(function(){
          updateClocks();
          loadMarkers(markersBasename(new Date(page_time.getTime() + fetch_offset)));
        }, 500);
        updateClocks();
        loadMarkers(markersBasename(page_time));
      };
      window.onload = initialize;
    </script>

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">
    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/emoji.css">

    <title>Emoticommits</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/zunda/emoticommits">View on GitHub</a>

          <h1 id="project_title">Emoticommits</h1>
          <h2 id="project_tagline">Commits and comments with emotions are good for your health <img class="emoji" title=":smile:" alt=":smile:" src="http://assets.github.com/images/icons/emoji/smile.png"></h2>

        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
      <div class="center">
        <p><span id="wall_clock">Wall clock</span> <span id="page_clock">Page clock</span></p>
        <iframe id="mapframe" src="./map.html" class="mapframe"
          frameBorder="0" scrolling="no"></iframe>
      </div>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p>Emoticommits is maintained by <a href="https://github.com/zunda">zunda</a> and
        published at <a href="http://zunda.github.io/emoticommits">http://zunda.github.io/emoticommits</a> with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
