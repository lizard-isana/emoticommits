<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Emoticommits : Commits and comments with emotions are good for your health :smile:" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">
    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/emoji.css">

    <title>Emoticommits</title>
    <script type="text/javascript">
      var avatar_duration = 600*1000; // 10 min
      var avatar_size = 32;
      var emoticon_duration = 1800*1000;  // 30 min
      var emoticon_size = 48;

      var markers_queue = new Array;
      var markers_on_map = new Array;
      function loadMarkers(basename) {
        var http = new XMLHttpRequest();
        http.open('GET', "markers/" + basename + ".json");
        http.send(null);
        http.onreadystatechange = function() {
          if ((http.readyState == 4) && (http.status == 200)) {
            JSON.parse(http.responseText).forEach(function(marker) {
              markers_queue.push(marker);
            });
            initializeClocks();
          };
        };
      };
      function addMarkers(page_time, wall_time) {
        while(markers_queue.length > 0 && new Date(markers_queue[0].time) < page_time) {
          var marker = markers_queue.shift();
          var icon = marker.icon;
          var size;
          var until;
          if (marker.emotion) {
            size = emoticon_size;
            until = new Date(wall_time.getTime() + emoticon_duration);
          } else {
            size = avatar_size;
            icon += "?s=" + size;
            until = new Date(wall_time.getTime() + avatar_duration);
          };
          var pin = mapwindow.dropPin(marker.lat, marker.lng, icon, size, marker.url);
          markers_on_map.push({until: until, marker: pin});
        };
      };
      function removeMarkers(wall_time) {
        while(markers_on_map.length > 0 && markers_on_map[0].until < wall_time) {
          markers_on_map.shift().marker.setMap(null);
        }
      }

      var time_offset;
      function updateClocks() {
        var wall_time = new Date();
        var page_time = new Date(wall_time.getTime() + time_offset);
        document.getElementById("wall_clock").innerHTML = wall_time.toLocaleString();
        document.getElementById("page_clock").innerHTML = page_time.toLocaleString();
        addMarkers(page_time, wall_time);
        removeMarkers(wall_time);
      };
      function initializeClocks() {
        var wall_time_start = new Date();
        var page_time_start = new Date(markers_queue[0].time);
        time_offset = page_time_start.getTime() - wall_time_start.getTime();
        setInterval(function(){updateClocks()}, 500);
      };

      var mapwindow;
      function initialize() {
        mapwindow = document.getElementById("mapframe").contentWindow;
        loadMarkers("2013042322");
      };
      window.onload = initialize;
    </script>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/zunda/emoticommits">View on GitHub</a>

          <h1 id="project_title">Emoticommits</h1>
          <h2 id="project_tagline">Commits and comments with emotions are good for your health <img class="emoji" title=":smile:" alt=":smile:" src="http://a248.e.akamai.net/assets.github.com/images/icons/emoji/smile.png"></h2>

        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <p><span id="wall_clock">Wall clock</span> <span id="page_clock">Page clock</span></p>
        <iframe id="mapframe" src="./map.html"
          height="100%" width="100%" frameBorder="0" scrolling="no">
        </iframe>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p>Emoticommits is maintained by <a href="https://github.com/zunda">zunda</a> and
        published at <a href="http://zunda.github.io/emoticommits">http://zunda.github.io/emoticommits</a> with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
